generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstname String
  lastname  String
  createdAt DateTime @default(now())
  clerkId   String   @unique
  image     String?

  // Relations
  groups        Group[]        @relation("UserGroups")
  memberships   Members[]
  posts         Post[]
  likes         Like[]
  comments      Comment[]
  messagesSent  Message[]      @relation("MessageSender")
  messagesRecv  Message[]      @relation("MessageReceiver")
  subscriptions Subscription[]
}

model Group {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String        @unique
  category        String
  thumbnail       String?
  description     String?
  gallery         String[]
  jsonDescription String?
  htmlDescription String?
  icon            String?
  createdAt       DateTime      @default(now())
  privacy         Group_PRIVACY @default(PRIVATE)
  active          Boolean       @default(false)
  domain          String?

  // Relations
  owner        User           @relation("UserGroups", fields: [userId], references: [id], onDelete: Cascade)
  userId       String         @db.Uuid
  members      Members[]
  channels     Channel[]
  courses      Course[]
  affiliate    Affiliate?
  subscription Subscription[]
  modules      Module[]
}

model Members {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())

  userId  String? @db.Uuid
  groupId String? @db.Uuid

  user  User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group? @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([userId, groupId])
}

model Post {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt   DateTime @default(now())
  title       String?
  htmlContent String?
  jsonContent String?

  authorId String  @db.Uuid
  moduleId String? @db.Uuid

  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  module   Module?   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  comments Comment[]
  likes    Like[]
}

model Comment {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())
  content   String
  replied   Boolean? @default(false)

  postId    String  @db.Uuid
  userId    String  @db.Uuid
  commentId String? @db.Uuid

  post   Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  reply  Comment[] @relation("CommentReplies")
  parent Comment?  @relation("CommentReplies", fields: [commentId], references: [id])
}

model Module {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  icon      String
  createdAt DateTime @default(now())
  groupId   String?  @db.Uuid

  group    Group?    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  posts    Post[]
  sections Section[]
}

model Section {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @default("New Section")
  icon        String   @default("doc")
  complete    Boolean  @default(false)
  createdAt   DateTime @default(now())
  moduleId    String?  @db.Uuid
  content     String?
  htmlContent String?
  jsonContent String?

  module Module? @relation(fields: [moduleId], references: [id], onDelete: Cascade)
}

model Like {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())
  userId    String   @db.Uuid
  postId    String   @db.Uuid

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Channel {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  createdAt DateTime @default(now())
  groupId   String   @db.Uuid

  group    Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  messages Message[]
}

model Message {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  message    String
  createdAt  DateTime @default(now())
  senderId   String?  @db.Uuid
  receiverId String?  @db.Uuid
  channelId  String?  @db.Uuid

  sender   User?    @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User?    @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  channel  Channel? @relation(fields: [channelId], references: [id], onDelete: Cascade)
}

model Course {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  description String?
  createdAt   DateTime @default(now())
  groupId     String?  @db.Uuid

  group Group? @relation(fields: [groupId], references: [id], onDelete: Cascade)
}

model Affiliate {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())
  groupId   String?  @unique @db.Uuid

  group Group? @relation(fields: [groupId], references: [id], onDelete: Cascade)
}

model Subscription {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  price     Int
  currency  String    @default("INR")
  active    Boolean   @default(false)
  startDate DateTime?
  endDate   DateTime?
  planType  String    @default("monthly") // monthly, yearly, etc.
  status    String    @default("PENDING") // PENDING, SUCCESS, FAILED, CANCELLED

  razorpayOrderId   String? @unique
  razorpayPaymentId String?
  razorpaySignature String?

  // Relations
  userId  String  @db.Uuid
  groupId String? @db.Uuid

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group? @relation(fields: [groupId], references: [id], onDelete: Cascade)
}

enum Group_PRIVACY {
  PUBLIC
  PRIVATE
}
