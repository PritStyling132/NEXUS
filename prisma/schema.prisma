generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstname String
  lastname  String
  createdAt DateTime @default(now())
  clerkId   String   @unique
  image     String?

  // NEW: Razorpay customer details for recurring payments
  razorpayCustomerId String?   @unique
  razorpayTokenId    String?   // Saved card token
  phone              String?   // Required for Razorpay
  trialEndsAt        DateTime? // When the 14-day trial ends

  // Relations
  groups        Group[]        @relation("UserGroups")
  memberships   Members[]
  posts         Post[]
  likes         Like[]
  comments      Comment[]
  messagesSent  Message[]      @relation("MessageSender")
  messagesRecv  Message[]      @relation("MessageReceiver")
  subscriptions Subscription[]
}

model Group {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String        @unique
  category        String
  thumbnail       String?
  description     String?
  gallery         String[]
  jsonDescription String?
  htmlDescription String?
  icon            String?
  createdAt       DateTime      @default(now())
  privacy         Group_PRIVACY @default(PRIVATE)
  active          Boolean       @default(false)
  domain          String?

  // Relations
  owner        User           @relation("UserGroups", fields: [userId], references: [id], onDelete: Cascade)
  userId       String         @db.Uuid
  members      Members[]
  channels     Channel[]
  courses      Course[]
  affiliate    Affiliate?
  subscription Subscription?  // Changed to singular - one subscription per group
  modules      Module[]
  videos       Video[]        // NEW: Video uploads
}

model Members {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())

  userId  String? @db.Uuid
  groupId String? @db.Uuid

  user  User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group? @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([userId, groupId])
}

model Post {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt   DateTime @default(now())
  title       String?
  htmlContent String?
  jsonContent String?

  authorId String  @db.Uuid
  moduleId String? @db.Uuid

  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  module   Module?   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  comments Comment[]
  likes    Like[]
}

model Comment {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())
  content   String
  replied   Boolean? @default(false)

  postId    String  @db.Uuid
  userId    String  @db.Uuid
  commentId String? @db.Uuid

  post   Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  reply  Comment[] @relation("CommentReplies")
  parent Comment?  @relation("CommentReplies", fields: [commentId], references: [id])
}

model Module {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  icon      String
  createdAt DateTime @default(now())
  groupId   String?  @db.Uuid

  group    Group?    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  posts    Post[]
  sections Section[]
}

model Section {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @default("New Section")
  icon        String   @default("doc")
  complete    Boolean  @default(false)
  createdAt   DateTime @default(now())
  moduleId    String?  @db.Uuid
  content     String?
  htmlContent String?
  jsonContent String?

  module Module? @relation(fields: [moduleId], references: [id], onDelete: Cascade)
}

model Like {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())
  userId    String   @db.Uuid
  postId    String   @db.Uuid

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Channel {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  icon      String?
  createdAt DateTime @default(now())
  groupId   String   @db.Uuid

  group    Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  messages Message[]
}

model Message {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  message    String
  createdAt  DateTime @default(now())
  senderId   String?  @db.Uuid
  receiverId String?  @db.Uuid
  channelId  String?  @db.Uuid

  sender   User?    @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User?    @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  channel  Channel? @relation(fields: [channelId], references: [id], onDelete: Cascade)
}

model Course {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  description String?
  thumbnail   String?  // Course cover image
  published   Boolean  @default(false) // Draft vs Published
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  groupId     String   @db.Uuid

  group            Group              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  videos           CourseVideo[]
  resources        CourseResource[]

  @@index([groupId])
  @@index([published])
}

model CourseVideo {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title         String
  caption       String?  // Video description
  videoUrl      String   // Uploadcare UUID for video
  thumbnailUrl  String   // Uploadcare UUID for thumbnail
  order         Int      @default(0) // For ordering videos in course
  duration      Float?   // Duration in seconds
  published     Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  courseId      String   @db.Uuid
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([order])
}

model CourseResource {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  url         String   // YouTube or external resource URL
  type        ResourceType @default(YOUTUBE)
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  courseId    String   @db.Uuid
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

enum ResourceType {
  YOUTUBE
  LINK
  DOCUMENT
}

model Affiliate {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())
  groupId   String?  @unique @db.Uuid

  group Group? @relation(fields: [groupId], references: [id], onDelete: Cascade)
}

// UPDATED: Subscription model for recurring payments
model Subscription {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Pricing
  price    Int    @default(9900) // â‚¹99 in paise
  currency String @default("INR")

  // Subscription lifecycle
  status           SubscriptionStatus @default(TRIAL)
  trialStartDate   DateTime           @default(now())
  trialEndDate     DateTime? // 14 days from creation
  subscriptionStartDate DateTime? // When billing actually starts
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelledAt      DateTime?
  
  // Razorpay recurring subscription details
  razorpaySubscriptionId String? @unique // The recurring subscription ID
  razorpayPlanId         String? // Plan ID (usually fixed)
  razorpayCustomerId     String? // Customer ID from User table (redundant but useful)
  
  // One-time payment fields (for card validation only)
  razorpayOrderId   String? @unique
  razorpayPaymentId String? @unique
  razorpaySignature String?

  // Payment tracking
  lastPaymentDate   DateTime?
  lastPaymentStatus String? // success, failed, pending
  failedPayments    Int       @default(0) // Track consecutive failures
  nextBillingDate   DateTime?

  // Relations
  userId  String @db.Uuid
  groupId String @unique @db.Uuid // One subscription per group

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([razorpaySubscriptionId])
}

enum Group_PRIVACY {
  PUBLIC
  PRIVATE
}

model Video {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  videoUrl      String   // Uploadcare UUID
  thumbnailUrl  String   // Uploadcare UUID for custom thumbnail
  caption       String   // User-provided description
  order         Int      @default(0)
  videoSize     Int?     // Size in bytes
  videoDuration Float?   // Duration in seconds (optional)

  groupId       String   @db.Uuid
  group         Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([createdAt])
}

enum SubscriptionStatus {
  TRIAL           // First 14 days, not yet charged
  ACTIVE          // Paying and active
  PAST_DUE        // Payment failed, grace period
  CANCELLED       // User cancelled
  EXPIRED         // Trial ended without payment
  PAUSED          // Temporarily paused
}